# 微信登录绑定手机号功能修复说明

## 修复内容

### 1. 修复手机号绑定逻辑

**问题描述：**
- 用户绑定手机号时，如果该用户已经绑定过该手机号，会提示"该手机号已被使用"
- 应该允许用户重新绑定相同的手机号，或者提示"已绑定"

**修复方案：**

在 `AuthController.java` 的 `bindPhone` 方法中：

1. **检查当前用户是否已绑定该手机号**
   - 如果是，返回"手机号已绑定"，而不是错误
   
2. **检查手机号是否被其他用户使用**
   - 使用 `findByPhone` 查找手机号对应的用户
   - 只有当手机号被其他用户使用时才返回错误
   - 如果是当前用户自己的手机号，则允许操作

```java
// 检查当前用户是否已绑定该手机号
if (request.getPhone().equals(user.getPhone())) {
    logger.info("用户 {} 已绑定该手机号，无需重复绑定", username);
    Map<String, Object> data = new HashMap<>();
    data.put("user", convertUserToDTO(user));
    data.put("message", "手机号已绑定");
    return ResponseEntity.ok(ApiResponse.success("手机号已绑定", data));
}

// 检查手机号是否已被其他用户使用
Users existingUser = userRepository.findByPhone(request.getPhone());
if (existingUser != null && !existingUser.getId().equals(user.getId())) {
    return ResponseEntity.badRequest()
            .body(ApiResponse.error("该手机号已被其他用户使用"));
}
```

### 2. 优化绑定成功后的跳转逻辑

**问题描述：**
- 手机号绑定成功后没有跳转到前端首页

**修复方案：**

在微信授权回调页面的JavaScript代码中，绑定成功后：

1. 保存token和用户信息到localStorage
2. 显示"绑定成功，正在跳转..."提示
3. 1秒后跳转到 `https://timetable.devtesting.top`

```javascript
if (data.status === 'success') {
    localStorage.setItem('token', token);
    localStorage.setItem('user', JSON.stringify(data.data.user));
    btn.textContent = '绑定成功，正在跳转...';
    setTimeout(() => {
        window.location.href = frontendUrl;
    }, 1000);
}
```

### 3. 已绑定用户直接跳转首页

**问题描述：**
- 已绑定手机号的用户再次登录时，仍然显示绑定页面

**当前逻辑：**

在 `AuthController.java` 的 `wechatCallback` 方法中：

```java
boolean needBindPhone = (Boolean) loginResult.getOrDefault("needBindPhone", false);

if (needBindPhone) {
    // 显示绑定手机号页面
} else {
    // 直接跳转到前端首页
}
```

在 `WechatLoginService.java` 的 `processWechatLogin` 方法中：

```java
// 判断是否需要绑定手机号
boolean needBindPhone = (user.getPhone() == null || user.getPhone().isEmpty());
```

**逻辑说明：**
- 如果用户的 `phone` 字段为空或null，`needBindPhone` 为 `true`，显示绑定页面
- 如果用户已经绑定了手机号，`needBindPhone` 为 `false`，直接跳转到首页

## 测试场景

### 场景1：新用户首次登录
1. 用户通过微信登录
2. 系统检测到用户没有绑定手机号
3. 显示绑定手机号页面
4. 用户输入手机号并点击确定
5. 绑定成功后跳转到 `https://timetable.devtesting.top/dashboard?tab=timetables`

### 场景2：已绑定用户再次登录
1. 用户通过微信登录
2. 系统检测到用户已绑定手机号
3. 直接显示"微信登录成功"，1.5秒后跳转到 `https://timetable.devtesting.top/dashboard?tab=timetables`

### 场景3：用户重复绑定相同手机号
1. 用户在绑定页面输入已绑定的手机号
2. 点击确定
3. 系统返回"手机号已绑定"
4. 跳转到 `https://timetable.devtesting.top/dashboard?tab=timetables`

### 场景4：用户绑定他人手机号
1. 用户在绑定页面输入已被其他用户使用的手机号
2. 点击确定
3. 系统提示"该手机号已被其他用户使用"
4. 用户需要输入其他手机号

## 前端URL配置

所有跳转都统一跳转到：`https://timetable.devtesting.top/dashboard?tab=timetables`

```java
String frontendUrl = "https://timetable.devtesting.top/dashboard?tab=timetables";
```

## API接口

### POST /auth/bind-phone

**请求：**
```json
{
  "phone": "15811384776"
}
```

**响应（成功）：**
```json
{
  "status": "success",
  "message": "手机号绑定成功",
  "data": {
    "user": {
      "id": 1,
      "username": "wx_xxx",
      "nickname": "雷娃",
      "phone": "15811384776",
      "hasPhone": true,
      "wechatAvatar": "https://..."
    },
    "message": "手机号绑定成功"
  }
}
```

**响应（已绑定）：**
```json
{
  "status": "success",
  "message": "手机号已绑定",
  "data": {
    "user": { ... },
    "message": "手机号已绑定"
  }
}
```

**响应（被占用）：**
```json
{
  "status": "error",
  "message": "该手机号已被其他用户使用"
}
```

## 注意事项

1. 绑定手机号接口需要JWT token认证
2. 手机号格式验证：`^1[3-9]\d{9}$`（1开头，11位数字）
3. 绑定成功后会自动保存token和用户信息到localStorage
4. 所有跳转统一到前端首页，前端根据用户状态显示相应页面

## 下次登录流程

用户绑定手机号后：
1. 下次通过微信登录
2. 系统通过`wechat_openid`找到用户记录
3. 检测到`phone`字段有值
4. 直接跳转到首页，不再显示绑定页面

## 数据库字段

确保 `users` 表有以下字段：
- `wechat_openid`: 微信OpenID（唯一标识）
- `phone`: 手机号
- `nickname`: 昵称
- `wechat_avatar`: 微信头像URL

