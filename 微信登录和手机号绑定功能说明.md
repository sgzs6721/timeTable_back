# 微信登录和手机号绑定功能说明

## 功能概述

实现了完整的微信登录流程，包括：
1. 微信用户信息的完整保存（头像、地理位置等）
2. 手机号绑定功能
3. 根据绑定状态智能跳转页面

## 数据库变更

### 新增字段（V36迁移脚本）

在`users`表中新增以下字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `wechat_openid` | VARCHAR(64) | 微信OpenID（唯一） |
| `wechat_unionid` | VARCHAR(64) | 微信UnionID |
| `wechat_avatar` | VARCHAR(512) | 微信头像URL |
| `wechat_sex` | TINYINT | 性别（0未知，1男，2女） |
| `wechat_province` | VARCHAR(50) | 省份 |
| `wechat_city` | VARCHAR(50) | 城市 |
| `wechat_country` | VARCHAR(50) | 国家 |
| `phone` | VARCHAR(20) | 手机号 |

### 索引

- `idx_users_wechat_openid` - 微信OpenID唯一索引
- `idx_users_wechat_unionid` - 微信UnionID索引
- `idx_users_phone` - 手机号索引
- `idx_users_wechat_phone` - 微信OpenID和手机号复合索引

## API接口

### 1. 微信授权URL获取

```http
GET /auth/wechat/auth-url
```

**响应示例：**
```json
{
  "status": "success",
  "message": "获取微信授权URL成功",
  "data": {
    "authUrl": "https://open.weixin.qq.com/connect/oauth2/authorize?..."
  }
}
```

### 2. 微信登录

```http
POST /auth/wechat/login
Content-Type: application/json

{
  "code": "微信授权码"
}
```

**响应示例：**
```json
{
  "status": "success",
  "message": "微信登录成功",
  "data": {
    "token": "jwt_token",
    "user": {
      "id": 1,
      "username": "wx_openid123",
      "nickname": "张三",
      "phone": null,
      "hasPhone": false,
      "wechatAvatar": "https://...",
      "wechatOpenid": "openid123",
      "wechatProvince": "广东",
      "wechatCity": "深圳"
    },
    "isNewUser": true,
    "needBindPhone": true
  }
}
```

### 3. 微信授权回调（自动处理）

```http
GET /auth/wechat/callback?code=xxx&state=xxx
```

该接口返回一个HTML页面，自动处理以下逻辑：
- 如果用户未绑定手机号：跳转到 `/bind-phone` 页面
- 如果已绑定手机号：跳转到首页 `/`
- 支持弹窗登录模式（通过postMessage传递数据）

### 4. 绑定手机号

```http
POST /auth/bind-phone
Authorization: Bearer {token}
Content-Type: application/json

{
  "phone": "13800138000",
  "verificationCode": "123456"  // 可选，如果需要短信验证
}
```

**响应示例：**
```json
{
  "status": "success",
  "message": "手机号绑定成功",
  "data": {
    "user": {
      "id": 1,
      "username": "wx_openid123",
      "nickname": "张三",
      "phone": "13800138000",
      "hasPhone": true,
      "wechatAvatar": "https://..."
    },
    "message": "手机号绑定成功"
  }
}
```

## 业务流程

### 微信登录流程

```
1. 前端调用 GET /auth/wechat/auth-url 获取授权URL
   ↓
2. 用户点击授权，跳转到微信授权页面
   ↓
3. 用户同意授权，微信回调到 GET /auth/wechat/callback
   ↓
4. 后端通过code获取access_token和用户信息
   ↓
5. 后端保存/更新用户信息（包括微信头像、地理位置等）
   ↓
6. 判断用户是否已绑定手机号
   ↓
7a. 未绑定：跳转到 /bind-phone 页面
7b. 已绑定：跳转到首页 /
```

### 用户数据保存逻辑

**首次登录：**
- 创建新用户记录
- `username` 使用 `wx_` + `openid` 格式
- 保存微信昵称、头像、地理位置（省市国家）、性别等信息
- `status` 设为 `APPROVED`（微信用户自动批准）
- `phone` 为空，`needBindPhone` 为 true

**再次登录：**
- 通过 `wechat_openid` 查找用户
- 更新微信昵称、头像等可能变化的信息
- 检查是否已绑定手机号

### 手机号绑定逻辑

1. 前端检测到 `needBindPhone: true`，显示绑定手机号页面
2. 用户输入手机号（可选：发送验证码验证）
3. 调用 POST /auth/bind-phone 绑定手机号
4. 后端验证：
   - 手机号格式是否正确（1开头，11位数字）
   - 手机号是否已被其他用户使用
5. 绑定成功后，跳转到首页

## 前端集成示例

### React示例

```javascript
// 1. 获取微信授权URL并打开登录窗口
const handleWechatLogin = async () => {
  const response = await fetch('/api/auth/wechat/auth-url');
  const data = await response.json();
  
  // 打开微信授权窗口
  const loginWindow = window.open(data.data.authUrl, 'wechat-login', 
    'width=500,height=600');
  
  // 监听登录成功消息
  window.addEventListener('message', (event) => {
    if (event.data.type === 'wechat_login_success') {
      const { token, user, needBindPhone } = event.data;
      
      // 保存token
      localStorage.setItem('token', token);
      localStorage.setItem('user', JSON.stringify(user));
      
      // 根据是否需要绑定手机号跳转
      if (needBindPhone) {
        router.push('/bind-phone');
      } else {
        router.push('/');
      }
    }
  });
};

// 2. 绑定手机号
const handleBindPhone = async (phone) => {
  const token = localStorage.getItem('token');
  
  const response = await fetch('/api/auth/bind-phone', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({ phone })
  });
  
  const data = await response.json();
  
  if (data.status === 'success') {
    // 更新用户信息
    localStorage.setItem('user', JSON.stringify(data.data.user));
    // 跳转到首页
    router.push('/');
  } else {
    alert(data.message);
  }
};
```

## 安全考虑

1. **手机号验证**：
   - 使用正则表达式验证手机号格式
   - 防止重复绑定（同一手机号只能绑定一个账号）
   
2. **Token认证**：
   - 绑定手机号接口需要JWT token认证
   - 确保只有已登录用户才能绑定手机号

3. **数据隐私**：
   - 不在日志中输出敏感信息（手机号部分打码）
   - 用户信息DTO中不包含密码等敏感字段

## 测试建议

### 测试场景

1. **新用户首次微信登录**
   - 验证用户创建
   - 验证微信信息保存
   - 验证跳转到绑定手机号页面

2. **已注册用户再次登录**
   - 验证用户信息更新
   - 验证已绑定手机号的用户直接跳转首页

3. **手机号绑定**
   - 验证手机号格式校验
   - 验证重复手机号拒绝
   - 验证绑定成功后的跳转

4. **边界情况**
   - 未授权访问绑定接口
   - 重复绑定手机号
   - 微信接口调用失败

## 数据库迁移

执行数据库迁移：

```bash
# 使用Maven Flyway插件
mvn flyway:migrate

# 或者重启应用，Spring Boot会自动执行迁移
mvn spring-boot:run
```

## 配置项

确保 `application.yml` 中配置了微信相关参数：

```yaml
wechat:
  app-id: your_app_id
  app-secret: your_app_secret
  redirect-uri: https://your-domain.com/timetable/api/auth/wechat/callback
  scope: snsapi_userinfo
  state: timetable_wechat_login
```

## 相关文件

### 新增文件
- `V36__Add_wechat_fields_to_users.sql` - 数据库迁移脚本
- `BindPhoneRequest.java` - 绑定手机号请求DTO

### 修改文件
- `WechatLoginService.java` - 微信登录服务
- `UserRepository.java` - 用户仓库（新增查询方法）
- `AuthController.java` - 认证控制器（新增绑定手机号接口）

## 注意事项

1. **jOOQ代码生成**：修改数据库后需要重新生成jOOQ代码
   ```bash
   mvn jooq-codegen:generate
   ```

2. **前端路由**：确保前端有对应的路由页面：
   - `/bind-phone` - 绑定手机号页面
   - `/` - 应用首页

3. **微信公众号配置**：
   - 确保redirect_uri在微信公众平台的授权回调域名中配置
   - 确保使用的scope权限已在公众号后台开启

## 后续优化建议

1. **短信验证码**：增加手机号验证码验证功能
2. **手机号解绑**：允许用户解绑和更换手机号
3. **多端登录**：支持同一微信账号在多端登录
4. **账号合并**：支持将微信账号与已有账号合并





